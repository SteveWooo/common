{"type":"deploy","content":"{\"type\":\"dir\",\"dirname\":\"modules\",\"path\":\"modules\",\"content\":{\"demo.js\":{\"type\":\"file\",\"filename\":\"demo.js\",\"data\":\"module.exports = {\\r\\n\\tcb : async(swc, task)=>{\\r\\n\\t\\tconsole.log(task.data.message);\\r\\n\\t\\treturn {\\r\\n\\t\\t\\tstatus : \\\"success\\\",\\r\\n\\t\\t\\t// error_message : \\\"\\\",\\r\\n\\t\\t\\ttask_id : task.task_id,\\r\\n\\t\\t}\\r\\n\\t}\\r\\n}\"},\"init_modules.js\":{\"type\":\"file\",\"filename\":\"init_modules.js\",\"data\":\"module.exports = {\\r\\n\\tdemo : require(\\\"./demo\\\"),\\r\\n\\ttest : require(\\\"./test\\\"),\\r\\n\\tkuaiyaojing : require(\\\"./kuaiyaojing\\\"),\\r\\n}\"},\"kuaiyaojing.js\":{\"type\":\"file\",\"filename\":\"kuaiyaojing.js\",\"data\":\"//http://app.kyj344.com:8880/api/public/?service=Video.getVideoList&uid=-9999&type=0&p=1\\r\\nconst request = require(\\\"request\\\");\\r\\nconst mysql = require(\\\"mysql\\\");\\r\\nconst config = {\\r\\n\\t\\\"mysql\\\" : {\\r\\n\\t\\t\\\"host\\\"     : \\\"localhost\\\",\\r\\n  \\t\\t\\\"user\\\"     : \\\"root\\\",\\r\\n  \\t\\t\\\"password\\\" : \\\"111111\\\",\\r\\n  \\t\\t\\\"database\\\" : \\\"porn\\\",\\r\\n  \\t\\t\\\"port\\\" : \\\"3306\\\"\\r\\n\\t}\\r\\n}\\r\\n\\r\\nfunction get_info(swc, page){\\r\\n\\treturn new Promise(resolve=>{\\r\\n\\t\\tvar option = {\\r\\n\\t\\t\\turl : \\\"http://app.kyj344.com:8880/api/public/?service=Video.getVideoList&uid=-9999&type=0&p=\\\" + page,\\r\\n\\t\\t\\tproxy : \\\"http://:@127.0.0.1:1080\\\"\\r\\n\\t\\t}\\r\\n\\r\\n\\t\\trequest(option, function(err, res, body){\\r\\n\\t\\t\\tif(err || res.statusCode != 200){\\r\\n\\t\\t\\t\\tresolve(undefined);\\r\\n\\t\\t\\t\\treturn ;\\r\\n\\t\\t\\t}\\r\\n\\r\\n\\t\\t\\tbody = JSON.parse(body);\\r\\n\\t\\t\\tresolve(body);\\r\\n\\t\\t})\\r\\n\\t})\\r\\n}\\r\\n\\r\\nfunction write_data(swc, sql, db_handle){\\r\\n\\treturn new Promise((resolve)=>{\\r\\n\\t\\tdb_handle.query(sql, (err)=>{\\r\\n\\t\\t\\tif(err){\\r\\n\\t\\t\\t\\tresolve(err);\\r\\n\\t\\t\\t\\treturn ;\\r\\n\\t\\t\\t}\\r\\n\\t\\t\\tresolve(\\\"done\\\");\\r\\n\\t\\t\\treturn ;\\r\\n\\t\\t})\\r\\n\\t})\\r\\n}\\r\\n\\r\\nfunction sleep(time){\\r\\n\\treturn new Promise(resolve=>{\\r\\n\\t\\tsetTimeout(()=>{\\r\\n\\t\\t\\tresolve();\\r\\n\\t\\t}, time)\\r\\n\\t})\\r\\n}\\r\\n\\r\\nasync function callback(swc, task){\\r\\n\\tvar db_handle = mysql.createConnection(config.mysql);\\r\\n\\t// console.log(task);\\r\\n\\tvar info = await get_info(swc, 1);\\r\\n\\tif(!info || info.ret != 200){\\r\\n\\t\\treturn {\\r\\n\\t\\t\\ttask_id : task.task_id,\\r\\n\\t\\t\\tstatus : \\\"faile\\\",\\r\\n\\t\\t\\tmessage : info.ret\\r\\n\\t\\t};\\r\\n\\t}\\r\\n\\r\\n\\tlet data = info.data.info;\\r\\n\\tconsole.log(\\\"length : \\\" + data.length);\\r\\n\\tfor(var i=0;i<data.length;i++){\\r\\n\\t\\tlet d = data[i];\\r\\n\\t\\t// console.log(i)\\r\\n\\t\\tvar video = {\\r\\n\\t\\t\\timage_url : d['thumb'],\\r\\n\\t\\t\\ttitle : d['title'],\\r\\n\\t\\t\\tuid : d[\\\"uid\\\"],\\r\\n\\t\\t\\tvideo_id : d['id'],\\r\\n\\t\\t\\tvideo_url : d[\\\"href\\\"]\\r\\n\\t\\t}\\r\\n\\r\\n\\t\\tfor(var k in video){\\r\\n\\t\\t\\tvideo[k] = mysql.escape(video[k]);\\r\\n\\t\\t}\\r\\n\\r\\n\\t\\tvar sql = `INSERT INTO \\\\`kuaiyaojing\\\\` (\\\\`image_url\\\\`,\\\\`video_id\\\\`,\\\\`uid\\\\`,\\\\`video_url\\\\`,\\\\`title\\\\`) VALUES (${video[\\\"image_url\\\"]},${video[\\\"video_id\\\"]},${video[\\\"uid\\\"]},${video[\\\"video_url\\\"]},${video[\\\"title\\\"]})`;\\r\\n\\t\\tlet res = await write_data(swc, sql, db_handle);\\r\\n\\t\\t// console.log(res);\\r\\n\\t}\\r\\n\\t// await sleep(2000);\\r\\n\\tconsole.log(new Date());\\r\\n\\tconsole.log(\\\"==\\\")\\r\\n\\treturn {\\r\\n\\t\\ttask_id : task.task_id,\\r\\n\\t\\tstatus : \\\"success\\\"\\r\\n\\t}\\r\\n}\\r\\n\\r\\nexports.callback = callback;\\r\\n\\r\\nfunction download_file(swc, video){\\r\\n\\treturn new Promise(resolve=>{\\r\\n\\t\\tvar stream = fs.createWriteStream(\\\"./kuaiyaojing/\\\" + video[\\\"title\\\"]);\\r\\n\\t\\trequest(video.video_url).pipe(stream).on('close', ()=>{\\r\\n\\t\\t\\tresolve(\\\"done\\\");\\r\\n\\t\\t}).on(\\\"error\\\", ()=>{\\r\\n\\t\\t\\tresolve(\\\"faile\\\");\\r\\n\\t\\t});\\r\\n\\t})\\r\\n}\\r\\n\\r\\nconst fs = require(\\\"fs\\\");\\r\\nasync function download(swc, task){\\r\\n\\tlet data = task.data;\\r\\n\\tdata[\\\"title\\\"] = data[\\\"title\\\"] + data[\\\"video_id\\\"];\\r\\n\\tlet res = await download_file(swc);\\r\\n\\tif(res == \\\"done\\\"){\\r\\n\\t\\tawait sleep(2000);\\r\\n\\t\\treturn {\\r\\n\\t\\t\\ttask_id : task_id,\\r\\n\\t\\t\\tstatus : \\\"success\\\"\\r\\n\\t\\t}\\r\\n\\t} else {\\r\\n\\t\\tfs.appendFileSync(\\\"./kuaiyaojing/error_vid\\\", data[\\\"video_id\\\"]);\\r\\n\\t\\treturn {\\r\\n\\t\\t\\ttask_id : task_id,\\r\\n\\t\\t\\tstatus : \\\"faile\\\",\\r\\n\\t\\t\\terror_message : {\\r\\n\\t\\t\\t\\tvideo : data\\r\\n\\t\\t\\t}\\r\\n\\t\\t}\\r\\n\\t}\\r\\n\\t\\r\\n}\"},\"test.js\":{\"type\":\"file\",\"filename\":\"test.js\",\"data\":\"module.exports = {\\r\\n\\trun : async (swc, task)=>{\\r\\n\\t\\tconsole.log(task.data);\\r\\n\\t\\treturn {\\r\\n\\t\\t\\tstatus : \\\"success\\\",\\r\\n\\t\\t\\ttask_id : task.task_id\\r\\n\\t\\t}\\r\\n\\t}\\r\\n}\"}}}","version":"1.0.0","time":1541865222587,"hoster_id":"","sign":""}